
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Runtime function patching in JS - Ingenious Coding</title>
	<meta name="author" content="Stephen Crane">

	
	<meta name="description" content="Have you ever needed to create a stub function which patched itself
with the real function at runtime? As part of some research I&#8217;ve been &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Ingenious Coding" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><div id="title">
  <h1><a href="/">Ingenious Coding</a></h1>
  
    <h2>Stephen Crane</h2>
  
</div>
<nav id="main-nav"><ul class="main">
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:ingeniouscoding.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/107858397455924944122?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/rinon" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/rinon" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:ingeniouscoding.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Runtime Function Patching in JS</h1>
	<div class="entry-content"><p>Have you ever needed to create a stub function which patched itself
with the real function at runtime? As part of some research I&#8217;ve been
working on lately, I found that I needed to do exactly this. Just to
make things more challenging this needed to be automated for <em>any</em>
valid JS function, no matter how crazy and convoluted. This post will
explore how I went about this and the rewriting I ended up with. I&#8217;ll
try to stick fairly close to how my function patching code actually
evolved, but this should certainly not be treated as a history.</p>

<p><em>Disclaimer:</em> This is still a work in progress, and although it&#8217;s been
tested with fairly large and comprehensive code bases, there may
certainly be edge cases I haven&#8217;t thought of. Please comment or send
me a message if you find any!</p>

<h3>Background</h3>

<p>I&#8217;m currently working on a JavaScript source-to-source compiler which
transforms any arbitrary function into a string and defers the
execution and parsing of the function until it gets called (if
ever). To do this, the compiler needs to rewrite a function into a
stub which fetches and parses the original code, and then replaces
itself with the real function.</p>

<h3>Starting out</h3>

<p>Let&#8217;s trace an example of rewriting a simple function. I&#8217;ll be using
human readable variable names, but in a compiler all generated
variable names would need to be checked against current valid variable
names and/or be namespaced to not conflict with any existing variable
names.</p>

<p>Here&#8217;s a simple example function to start out with:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Hello, world!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// and actually execute the function</span>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>It turns out that in JavaScript you can assign a value to a function
name from inside that function. So, I started by simply replacing the
original function with the following stub:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fooStr</span> <span class="o">=</span> <span class="s2">&quot;function() {console.log(&#39;Hello, world!&#39;);}&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">foo</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">foo</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note: We can do an analogous rewrite to anonymous functions assigned
to variables. Awesome, we just need to define <code>loadFunction</code> and we&#8217;re
done, right? Shouldn&#8217;t be too hard&#8230; Let&#8217;s give it a try:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There, that should just about do it&#8230; What&#8217;s that you say?  <code>eval()</code>
is complaining about not being able to parse the function?  Oh, let&#8217;s
see, it seems that the anonymous function needs to be wrapped in
parens so it can be parsed as a StatementExpression! Ok, fine:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fooStr</span> <span class="o">=</span> <span class="s2">&quot;(function() {console.log(&#39;Hello, world!&#39;);})&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome, it works now!</p>

<p>One thing to note here &#8211; <code>loadFunction</code> needs to be in the same frame
(function scope) as the original function so that the function created
with <code>eval</code> closes over the same variables as the original function
would have. This means that nested functions will need a different
<code>loadFunction</code> at each nesting level containing a rewritten function
so the <code>eval</code> occurs in the correct scope.</p>

<h3>Patching references</h3>

<p>Now, we&#8217;re not done yet&#8230; What if some other part of the code took a
reference to <code>foo</code> before it executed? Something simple like <code>var
fooAlias = foo;</code> would do this.  Now, <code>fooAlias</code> will get a reference
to the stub, and every time <code>fooAlias</code> was called, the function would
have to be recreated. This is, of course, horribly bad for
performance! While we can&#8217;t replace references to the stub, we can
make the stub into a simple trampoline that stores the loaded function
and jumps to it if available. Although there are probably other ways
to do this, I chose to set the function string variable (<code>fooStr</code> in
this case) to null, and check to make sure it was a valid string
before the <code>eval</code>. With this change, the code now looks like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">fnStr</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">foo</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">foo</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fooAlias</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">fooAlias</span><span class="p">();</span>
</span><span class='line'><span class="nx">fooAlias</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first time <code>fooAlias</code> is called, <code>fooStr</code> will be a valid string
and the function will be created as it should. The second call will
still result in a call to <code>loadFunction</code>, but this will immediately
return the replaced version of <code>foo</code>, without recreating it.</p>

<h3>Redefinition</h3>

<p>Well, now this is all fine and dandy, but does it work for all cases?
Unfortunately, as you may have guessed, not yet. First of all, what
happens if the code redefines <code>foo</code> after we rewrite it? (I ran into
this while trying to compile
<a href="https://github.com/kripken/BananaBread">BananaBread</a>, where a
function is redefined to extend it with a bit of new
functionality). For example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">oldFoo</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;In the new foo&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">oldFoo</span><span class="p">();</span>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>should output:</p>

<pre><code>foo
now in the new foo
</code></pre>

<p>Using the current transformation, we would rewrite this code to:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fooStr1</span> <span class="o">=</span> <span class="s1">&#39;(function(){console.log(&quot;foo&quot;)})&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fooStr2</span> <span class="o">=</span> <span class="s1">&#39;(function(){console.log(&quot;In the new foo&quot;)})&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">foo</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr1</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr1</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">foo</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">oldFoo</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">foo</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr2</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr2</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">foo</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">oldFoo</span><span class="p">();</span>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>but this outputs:</p>

<pre><code>foo
foo
</code></pre>

<p>Wait a second! That&#8217;s not what we expected! What happened? Well, if
you trace carefully, you will see that the call to <code>oldFoo()</code> on line
18 overwrites <code>foo</code> with the version of <code>foo</code> generated from
<code>fooStr1</code>.  This is then called as <code>foo()</code> on line 19 and the old
version is executed, rather than the correctly redefined version.</p>

<p>We can avoid this by overwriting the stub with the generated function
<em>only</em> when it has not been changed elsewhere. This is easily done by
checking that <code>foo === arguments.callee</code> before overwriting <code>foo</code> (be
careful here: <code>arguments.callee</code> is not the same as <code>this</code> in the
browser, as one might expect &#8211; see
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Operators/this">this MDN doc</a>
for more info).</p>

<p>With this change, the rewritten code now looks like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fooStr1</span> <span class="o">=</span> <span class="s1">&#39;(function(){console.log(&quot;foo&quot;)})&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fooStr2</span> <span class="o">=</span> <span class="s1">&#39;(function(){console.log(&quot;In the new foo&quot;)})&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr1</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr1</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">foo</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">temp</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">oldFoo</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">temp</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr2</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr2</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">foo</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">temp</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">oldFoo</span><span class="p">();</span>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This now works as expected. Unfortunately <code>loadFunction</code> will still get called
every time <code>oldFoo</code> is called, but fixing this would add length to the
stub, which I&#8217;d like to avoid.</p>

<p>Unfortunately we also need to keep track of each stub (and
replacement) so that <code>loadFunction</code> works correctly. Without this, a
second call to <code>oldFoo</code> which in turn calls <code>loadFunction</code>, returning
<code>foo</code>, will return the wrong version of <code>foo</code>! If that seems a bit
convoluted, it&#8217;s probably because it is. Hopefully tracing through the
code will help:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">generated1</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">generated2</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fooStr1</span> <span class="o">=</span> <span class="s1">&#39;(function(){console.log(&quot;foo&quot;)})&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fooStr2</span> <span class="o">=</span> <span class="s1">&#39;(function(){console.log(&quot;In the new foo&quot;)})&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">generated1</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr1</span><span class="p">,</span> <span class="nx">generated1</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr1</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">foo</span> <span class="o">=</span> <span class="nx">generated1</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">generated1</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">oldFoo</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">generated2</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr2</span><span class="p">,</span> <span class="nx">generated2</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr2</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">foo</span> <span class="o">=</span> <span class="nx">generated2</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">generated2</span><span class="p">();</span>
</span><span class='line'><span class="p">},</span> <span class="nx">generated2</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">oldFoo</span><span class="p">();</span>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This stores the stubs in <code>generated1</code> and <code>generated2</code> respectively,
and then overwrites these vars when the function is loaded, regardless
of whether we can replace the <code>foo</code> name itself. Pay special attention
to where these vars were assigned to. <code>generated1</code> must be assigned at
the top of the function because function declarations are lifted to
the top of their frame in JavaScript, and we cannot assign to
<code>generated2</code> until after <code>foo</code> is redefined.</p>

<p>All that&#8217;s left now for the stub is to properly pass arguments and
context to the loaded function by using <code>.apply()</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">generated1</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr1</span><span class="p">,</span> <span class="nx">generated1</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr1</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">foo</span> <span class="o">=</span> <span class="nx">generated1</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">generated1</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Properties</h3>

<p>Finally, there&#8217;s one last piece of the puzzle &#8211; copying over any
attributes that should be attached to the function being loaded, but
that instead were attached to the stub. For example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">generated</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr</span><span class="p">,</span> <span class="nx">generated</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">foo</span> <span class="o">=</span> <span class="nx">generated</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">generated</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">foo</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">prototypeMethod</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">foo</span><span class="p">.</span><span class="nx">objectMethod</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, <code>prototypeMethod</code> and <code>objectMethod</code> were attached to
the stub prototype and object. When <code>foo</code> is loaded and the stub
replaced, these methods disappear! We need to extend <code>loadFunction</code> to
copy any properties over to the loaded function like so:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">fnStr</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">temp</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">temp</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">temp</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Putting it all together</h3>

<p>Here&#8217;s my final version of function loading and patching for a typical
function:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">generated</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">fnStr</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">fnStr</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">temp</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">temp</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">temp</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fooStr</span> <span class="o">=</span> <span class="s1">&#39;(function(){console.log(&quot;foo&quot;)})&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">generated</span> <span class="o">=</span> <span class="nx">loadFunction</span><span class="p">(</span><span class="nx">fooStr</span><span class="p">,</span> <span class="nx">generated</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fooStr</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">foo</span> <span class="o">=</span> <span class="nx">generated</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">generated</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This covers every edge case that I could think of, and should work to
patch a function at runtime (as well as possible).</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-08-17T15:00:00-07:00" pubdate data-updated="true">Aug 17<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>JavaScript</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Stephen Crane

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'ingeniouscoding';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ingeniouscoding.com/blog/2012/08/17/runtime-function-patching-in-js/';
        var disqus_url = 'http://ingeniouscoding.com/blog/2012/08/17/runtime-function-patching-in-js/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-34034744-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>